= Logging
:experimental:

Cider Log Mode allows you to capture, debug, inspect and view log
events emitted by Java logging frameworks. The captured log events can
be searched, streamed to the client, pretty printed and are integrated
with the Cider link:inspector.html[Inspector] and
link:debugger.html[Debugger]. Here is a screenshot of Cider Log Mode
in action.

image::cider-log.png[CIDER Log]

NOTE: The screenshot displays the list of log events in the
`+*cider-log*+` buffer on the left. To the right, a log event is
visible in the `+*cider-inspect*+` buffer, where the exception of the
event is also displayed in the Cider Debugger. From the debugger you
can jump to the source of each frame. At the bottom the Cider log menu
is shown from which you can perform logging related actions.

== Features

- Browse Javadocs and website of log framework.
- Search log events and show them in buffers.
- Pretty print log events.
- Show log events in the Cider link:inspector.html[Inspector]
- Show log event exceptions in the Cider link:debugger.html[Debugger]

== Usage

To use Cider Log Mode, type kbd:[C-c l l] or kbd:[M-x cider-log] in
any buffer that has a Cider https://github.com/vspinu/sesman[Sesman]
session attached to it. The first time you run the command, it will
prompt you to select a log framework to use, and then attach a log
appender to the root logger of the selected framework. After the log
appender has been attached, the `cider-log` command will show a
https://www.gnu.org/software/emacs/manual/html_mono/transient.html[Transient]
menu, from which you can take further actions, like managing the log
framework, appenders, consumers and events.

To view log events and stream them to your client, type kbd:[es]
(Search log events) followed by kbd:[s]. This will open the
`+*cider-log*+` buffer showing any log events captured thus far. It will
also add a log consumer to this buffer, which receives newly-arriving
log events.

NOTE: The `+*cider-log*+` buffer might initially be empty, and you may
see a `No log events found` message. This is because nothing has been
logged between adding the appender and searching for events. So, now
would be a good time to run some code that triggers a log event for
the selected framework.

=== Keybindings

|===
| Command | Keyboard shortcut | Description

| `cider-log`
| kbd:[C-c l l]
| Show the Cider log menu.

| `cider-log-appender`
| kbd:[C-c l a]
| Show the menu to manage appenders of a logging framework.

| `cider-log-consumer`
| kbd:[C-c l c]
| Show the menu to manage consumers listening to log events.

| `cider-log-event`
| kbd:[C-c l e]
| Show the menu to manage log events.
|===

== Log framework

Cider Log Mode supports log frameworks that allow reconfiguration at
run time. More specifically the framework should support attaching log
appenders to loggers, in order to capture events.

At the moment the following log frameworks are supported:

- https://docs.oracle.com/en/java/javase/19/core/java-logging-overview.html[Java Util Logging]
- https://logback.qos.ch[Logback]

There is some work in progress to support
https://logging.apache.org/log4j/2.x/[Log4j] as well, but there are
some https://stackoverflow.com/a/17842174/12711900[difficulties] with
configuration changes made at runtime, which are wiped out by the
Log4j2's reconfiguration mechanism.

=== Keybindings

|===
| Command | Keyboard shortcut | Description

| `cider-log-set-framework`
| kbd:[C-c l f s]
| Select the log framework to use.

| `cider-log-set-buffer`
| kbd:[C-c l f b]
| Select the log buffer to user. Default: `+*cider-log*+`

| `cider-log-framework-browse-javadoc`
| kbd:[C-c l f j]
| Browse the Javadocs of the log framework.

| `cider-log-framework-browse-website`
| kbd:[C-c l f w]
| Browse the website of the log framework.
|===

== Log Appender

In order to capture log events, a log appender needs to be attached to
a logger of a framework. Once an appender is attached to a logger it
captures the log events emitted by the framework in an in-memory
atom. A log appender can be configured to have a certain size
(default: 100000) and a threshold in percentage (default: 10). Log
events are cleared from the appender when threshold (appender size
plus threshold) is reached. Additionally an appender can be configured
to only capture events that match a set of filters.

image::cider-log-appender.png[CIDER Log Consumer]

=== Keybindings

The following keybindings can be used to interact with log appenders.

|===
| Command | Keyboard shortcut | Description

| `cider-log-appender`
| kbd:[C-c l A]
| Show the transient menu to manage log appenders.

| `cider-log-appender-add`
| kbd:[C-c l a a]
| Add a log appender to a logger.

| `cider-log-appender-clear`
| kbd:[C-c l a c]
| Clear all captured events of a log appender.

| `cider-log-appender-kill`
| kbd:[C-c l a k]
| Kill a log appender by removing it from the logger.

| `cider-log-appender-update`
| kbd:[C-c l a u]
| Update the filters, size or threshold of a log appender.
|===

== Log Consumer

Log events can be streamed to a client by attaching a log consumer to
an appender. Once a log consumer has been attached to an appender, it
will receive events from the appender. Similar to log appenders,
consumers can also be configured with a set of filters to only receive
certain events.

image::cider-log-consumer.png[CIDER Log Consumer]

=== Keybindings

The following keybindings can be used to interact with log consumers.

|===
| Command | Keyboard shortcut | Description

| `cider-log-consumer`
| kbd:[C-c l C]
| Show the transient menu to manage log consumers.

| `cider-log-consumer-add`
| kbd:[C-c l c a]
| Add a log consumer to a log appender streaming event to the client.

| `cider-log-consumer-kill`
| kbd:[C-c l c k]
| Kill a log consumer and stop streaming events to the client.

| `cider-log-consumer-update`
| kbd:[C-c l c u]
| Update the filters of a log consumer to change which events are streamed to the client.
|===

== Log Event

Log events can be searched, streamed to a client or viewed in Cider's
Inspector and Debugger. When searching log events the user can specify
a set of filters. Events that match the filters are shown in the
`+*cider-log*+` buffer. Additinally a log consumer will be attached to
the appender to receive log events matching the search criteria after
the search command has been issued. The log appender will be removed
automatically once a new search has been submitted or when the
`+*cider-log*+` buffer gets killed.

image::cider-log-event.png[CIDER Log Event]

=== Keybindings

The following keybindings can be used to interact with log events.

|===
| Command | Keyboard shortcut | Description

| `cider-log-event`
| kbd:[C-c l E]
| Show the transient menu to manage log events.

| `cider-log-event-clear-buffer`
| kbd:[C-c l e c]
| Clear all events from the log event buffer.

| `cider-log-event-show-stacktrace`
| kbd:[C-c l e e]
| Show the stacktrace of the log event at point in the Cider debugger.

| `cider-log-event-inspect`
| kbd:[C-c l e i]
| Show the log event in the Cider Inspector.

| `cider-log-event-pretty-print`
| kbd:[C-c l e p]
| Pretty print the log event in the `+*cider-log-event*+` buffer.

| `cider-log-event-search`
| kbd:[C-c l e s]
| Search log events and show them in the `+*cider-log*+` buffer.
|===

== Log Filters

Filters for log events can be attached to log appenders and
consumers. They also take effect when searching events or streaming
them to clients. If multiple filters are chosen they are combined
using logical AND condition. The following filters are available:

|===
| Filter  | Keyboard shortcut | Description

| `end-time`
| kbd:[-e]
| Only include log events that were emitted before `end-time`.

| `exceptions`
| kbd:[-E]
| Only include log events caused by an exception in the list of `exceptions`.

| `levels`
| kbd:[-l]
| Only include log events with a log level in the list of `levels`.

| `loggers`
| kbd:[-L]
| Only include log events that were emitted by a logger in the list of `loggers`.

| `pattern`
| kbd:[-r]
| Only include log events whose message matcches the regular expression `pattern`.

| `start-time`
| kbd:[-s]
| Only include log events that were emitted at, or after `start-time`.

| `threads`
| kbd:[-t]
| Only include log events that were emitted by a thread in the list of `threads`.
|===
